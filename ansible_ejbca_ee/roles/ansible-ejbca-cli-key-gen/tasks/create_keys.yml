---

- name: Check what keys are on the SoftCryptoToken {{ item.0.crypto_token_name }}
  command: >
    {{ ejbca_home }}/bin/ejbca.sh cryptotoken listkeys --token {{ item.0.crypto_token_name }}
  become: yes
  become_user: "{{ ejbca_user }}"
  register: soft_cryptotoken_list_keys

- name: Create key in crypto token {{ item.0.crypto_token_name }} - {{ item.1.key_label }}:{{ item.1.key_size }}
  command: >
    {{ ejbca_home }}/bin/ejbca.sh cryptotoken generatekey --token {{ item.0.crypto_token_name }} --alias {{ item.1.key_label }}  --keyspec {{ item.1.key_size }}
  no_log: true
  become_user: "{{ ejbca_user }}"
  when: item.0.name not in soft_cryptotoken_list_keys.stdout
