---

- name: Key Binding Keys
  block:

    - name: Generate Keys for Key Bindings
      include_role:
        name: ansible-ejbca-ctb-keygen
      loop: "{{ ejbca_keybinding |subelements('crypto_token') }}"
      loop_control:
        label: "{{ key_item.0.slot_identifier_value }}"
        loop_var: key_item
      no_log: true
      tags: hsm_test, clienttoolbox_key_generation
      when: ("PKCS11CryptoToken" in key_item.0.tokentype)

  when: ejbca_keybinding[0] is defined

- name: Check deployment
  include_tasks: check_deployment.yml
  tags: check_deployment
  when: peer_generate_hsm_keys[0] is defined

- name: Create Key Binding for Peering
  include_role:
    name: ansible-ejbca-key-binding
  vars:
    key_bindings: "{{ ejbca_keybinding }}"
    auth_key_bind: true
  when: 
    - use_external_va|bool or use_external_ra|bool or use_external_ss|bool

- name: Create Peer Connector
  include_role:
    name: ansible-ejbca-peer-connector
  when: use_external_va|bool or use_external_ra|bool or use_external_ss|bool
