---

- name: Download external CA chain for creating an External CA {{ item.caname }}
  uri:
    url: "{{ item.externalcachain_url }}"
    validate_certs: no
    dest: "{{ item.externalcachain_file }}"
    creates: "{{ item.externalcachain_file }}"
    owner: "{{ ejbca_user }}"
    group: "{{ ejbca_group }}"
  no_log: true

- name: Import External CA - {{ item.rootDn }}
  command: >
    {{ ejbca_home }}/bin/ejbca.sh ca importcacert
    --caname {{ item.rootDn }}
    -f {{ item.externalcachain_file }}
  no_log: true
  become: yes
  become_user: "{{ ejbca_user }}"
  register: import_external_ca
  failed_when: import_external_ca.rc >= 2
  changed_when: import_external_ca.rc == 0

- debug:
    msg: "Initializing CA failed with message: {{ import_external_ca.stdout }}"
  when: import_external_ca.rc == 1
