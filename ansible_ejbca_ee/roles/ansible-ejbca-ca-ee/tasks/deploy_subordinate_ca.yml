---

- name: Test that HSM slots are available
  include_tasks: hsm_test.yml
  loop: "{{ sub_test_slots }}"
  loop_control:
    label: "{{ item.slot_identifier }}"
  no_log: true
  tags: hsm_test
  when: sub_test_slots[0] is defined

- name: Generate HSM keys
  include_tasks: clienttoolbox_key_generation.yml
  loop: "{{ sub_generate_hsm_keys }}"
  loop_control:
    label: "{{ item.slot_identifier }}"
  no_log: true
  tags: clienttoolbox_key_generation
  when: sub_generate_hsm_keys[0] is defined

- name: Check deployment
  include_tasks: check_deployment.yml
  tags: check_deployment
  when: management_database_indexes.apply_indexes or sub_add_certification_authorities[0] is defined or management_import_certification_authorities[0] is defined or management_add_end_entities[0] is defined or management_add_administrators[0] is defined

- name: Apply indexes
  include_tasks: config_apply_indexes.yml
  when: management_database_indexes.apply_indexes

- name: Initialize Policy or Subordinate CAs with CLI commands
  include_tasks: init_sub_ca.yml
  loop: "{{ sub_add_certification_authorities }}"
  loop_control:
    label: "{{ item.caname }}"
  no_log: true
  tags: create_cas
  when: sub_add_certification_authorities[0] is defined

- name: Copy CA CSRs to the Ansible Controller 
  include_tasks: copy_csr_local.yml
  tags: create_cas
  when: sub_add_certification_authorities[0] is defined  
