---

- name: Check if CloudHSM directory exists
  stat:
    path: '{{ cloudhsm_home }}'
  register: cloudhsm_home_check
  
- block:
  name: CloudHSM client installation

  - name: Download CloudHSM client package
    get_url:
      url: '{{ cloudhsm_client_url }}/{{ cloudhsm_client_file }}'
      dest: '{{ cloudhsm_dest }}/{{ cloudhsm_client_file }}'
    register: cloudhsm_client_download

  - name: Install CloudHSM client package
    shell: rpm -i {{ cloudhsm_dest }}/{{ cloudhsm_client_file }}

  - name: Enable CloudHSM client service
    service:
      name: cloudhsm-client
      enabled: yes

  - name: Remove CloudHSM client package
    file:
      path: '{{ cloudhsm_dest }}/{{ cloudhsm_client_file }}'
      state: absent

  when:
    - not cloudhsm_home_check.stat.exists

# P11NG driver install

- name: Check if PKCS P11NG driver exists
  stat:
    path: /opt/cloudhsm/lib/libcloudhsm_pkcs11.so
  register: p11ng_driver_check
  when: use_p11ng | bool

- block:
  name: P11NG driver install

  - name: Download CloudHSM PKCS11 package
    get_url:
       url: '{{ cloudhsm_pkcs11_url }}/{{ cloudhsm_pkcs11_file }}'
       dest: '{{ cloudhsm_dest }}/{{ cloudhsm_pkcs11_file }}'
    register: cloudhsm_pcks11_download

  - name: Install CloudHSM pkcs11 package
    command: rpm -i {{ cloudhsm_dest }}/{{ cloudhsm_pkcs11_file }}

  - name: Remove CloudHSM PKCS11 package
    file:
      path: '{{ cloudhsm_dest }}/{{ cloudhsm_pkcs11_file }}'
      state: absent
  
  when:
    - use_p11ng | bool
    - not p11ng_driver_check.stat.exists

- name: Check if PrimeKey CloudHSM directory exists
  stat:
    path: /opt/PrimeKey
  register: organization_home_check

- block:
  name: Liquidsec library and clientToolBox unzip

  - name: Unpack PrimeKey zip
    unarchive:
      src: '{{ hsm_config_files }}/PrimeKey.zip'      
      dest: "/var/tmp"
      remote_src: true
      owner: '{{ signsrv_user }}'
      group: '{{ signsrv_group }}'
      mode: 0755
  
  - name: Move PrimeKey directory
    command: mv /var/tmp/opt/PrimeKey /opt/
  
  when: 
    - not organization_home_check.stat.exists
    