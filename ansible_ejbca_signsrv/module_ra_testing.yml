---

  - name: test my new module
    hosts: ca-host
    become: yes
    become_method: sudo
    gather_facts: no

    vars:
      ejbca_user: wildfly
      ejbca_home: /opt/ejbca
    tasks:

      # addendentity
      - name: Add End Entity
        ejbca_ra:
          cmd: addendentity
          username: test-user
          caname: Development-Issuing-CA
          subject_dn: CN=test-user,O=Testing,C=US
          #cp: ClientAuth-CP
          #eep: Entity-EEP2
          password: foo123
          type: 1
          token: USERGENERATED
          path: "{{ ejbca_home }}"
        become: true
        become_user: "{{ ejbca_user }}"
        register: module_output
        tags: addendentity

      # delendentity
      - name: Delete End Entity
        ejbca_ra:
          cmd: delendentity
          username: test-user
          path: "{{ ejbca_home }}"
        become: true
        become_user: "{{ ejbca_user }}"
        register: module_output
        tags: delendentity

      # findendentity
      - name: Query End Entity
        ejbca_ra:
          cmd: findendentity
          username: test-user
          path: "{{ ejbca_home }}"
        become: true
        become_user: "{{ ejbca_user }}"
        register: module_output
        tags: findendentity

      - name: dump module output
        debug:
          msg: "{{ module_output }}"
        tags: always
