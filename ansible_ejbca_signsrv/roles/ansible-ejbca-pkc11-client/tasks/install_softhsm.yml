---

- name: Install SoftHSM on CentOS, RedHat, Oracle
  block:
    - name: Stage Okay Repo GPG Key on CentOS, RedHat, Oracle
      copy:
        src: RPM-GPG-KEY-okayinc
        dest: /etc/pki/rpm-gpg/
        owner: root
        group: root
        mode: 0644

    - name: Import Okay Repo key from a file on CentOS, RedHat, Oracle
      rpm_key:
        state: present
        key: /etc/pki/rpm-gpg/RPM-GPG-KEY-okayinc

    - name: Install SoftHSM on CentOS, RedHat, Oracle 8
      dnf:
        name: "{{ softhsm_8 }}"
        state: present
        #disable_gpg_check: yes

  when: 
    - (ansible_facts['distribution'] == "CentOS" and ansible_facts['distribution_major_version'] == "8") or
      (ansible_facts['distribution'] == "RedHat" and ansible_facts['distribution_major_version'] == "8") or
      (ansible_facts['distribution'] == "OracleLinux" and ansible_facts['distribution_major_version'] == "8")

- name: Install SoftHSM on Alma or Rocky Linux
  block:

    - name: Upload SoftHSM RPM from Ansible controller to Alma/Rocky 8 Linux
      unarchive:
        src: "{{ softhsm_remote_dir }}"
        dest: /var/tmp
      register: unpacked_local_softhsm_rpm
      when: 
        - use_local_repository is defined
        - use_local_repository|bool

    - name: Download SoftHSM RPM and check (sha256) on Alma/Rocky 8 Linux
      get_url:
        url: "{{ download_softhsm_url }}"
        dest: /var/tmp/softhsm.rpm
        checksum: "{{ download_softhsm_url_checksum }}"
        timeout: 60
      register: download_softhsm_status
      when: 
        - use_local_repository is defined
        - not use_local_repository|bool

    # Dirty way to do this since the package doesn't show up in AppStream when searching from the server :-(
    - name: Install SoftHSM on Alma/Rocky 8 Linux
      command: >
        dnf install -y /var/tmp/softhsm.rpm
      register: install_softhsm_rpm

    - name: Remove installed SoftHSM RPM on Alma/Rocky 8 Linux
      file:
        path: /var/tmp/softhsm.rpm
        state: absent

  when:
    - (ansible_facts['distribution'] == "Rocky" and ansible_facts['distribution_major_version'] == "8") or
      (ansible_facts['distribution'] == "AlmaLinux" and ansible_facts['distribution_major_version'] == "8")

- name: Install SoftHSM on CentOS/RHEL 7
  yum:
    name: "{{ softhsm_7 }}"
    state: present
  when: 
    - (ansible_facts['distribution'] == "CentOS" and ansible_facts['distribution_major_version'] == "7") or
      (ansible_facts['distribution'] == "RedHat" and ansible_facts['distribution_major_version'] == "7") 

- name: Install SoftHSM Amazon Linux 2
  yum:
    name: softhsm
    state: present
  when: 
    - (ansible_facts['distribution'] == "Amazon" and ansible_facts['distribution_major_version'] == "2") 

- name: Set permissions on softhsm lib directory
  file:
    path: /var/lib/softhsm
    state: directory
    recurse: yes
    mode: 0750
    owner: "{{ ejbca_user }}"
    group: "{{ ejbca_group }}"

- name: Create SoftHSM slots for a new deployment
  block:

    - name: Check SoftHSM Slots
      shell: >
        softhsm2-util --show-slots | grep {{ item.slot_name }}
      register: show_hsm_slots
      loop: "{{ softhsm_gen_hsm_slots }}"
      changed_when: show_hsm_slots.rc != 0
      failed_when: false
      no_log: true

    - name: Create SoftHSM slots
      command: >
        softhsm2-util 
        --init-token 
        --free 
        --label {{ item.item.slot_name }} 
        --so-pin {{ item.item.slot_so_pin }} 
        --pin {{ item.item.slot_pin }}
      become: yes  
      become_user: "{{ ejbca_user }}" 
      loop: "{{ show_hsm_slots.results }}"
      no_log: true
      register: create_hsm_slots
      when: 
        - item.changed

  when:
    - create_softhsm_slots|bool
