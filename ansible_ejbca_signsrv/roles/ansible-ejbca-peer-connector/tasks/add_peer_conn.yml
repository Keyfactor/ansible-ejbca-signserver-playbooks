---

- name: Create Peer {{ item.name }}
  ejbca_peer:
    cmd: create
    name: "{{ item.name }}"
    state: "{{ item.state|default('ENABLED') }}"
    url: "{{ item.url }}"
    akb: "{{ item.keybinding }}"
    path: "{{ ejbca_home }}"
  become: true
  become_user: "{{ ejbca_user }}"
  register: create_peer_conn

- name: Enable Process incoming requests in Peer Connection EJBCA >= 7.4.0
  ejbca_peer:
    cmd: edit
    id: "{{ peer_id }}"
    max: "{{ ra_peer_max_parallel_reqs|default('50') }}"
    min: "{{ ra_peer_max_parallel_reqs|default('2') }}"
    process_incoming: true
    path: "{{ ejbca_home }}"
  vars:
    peer_id: "{{ create_peer_conn.peers|map(attribute='id')|join('') }}"
  become: true
  become_user: "{{ ejbca_user }}"
  register: update_peer_conn
  when:
    - item.type == 'ra'

#- debug: msg={{ update_peer_conn }}